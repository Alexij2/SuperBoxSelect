/*!
 * SuperBoxSelect - Advanced Listbox / Resource List Template Variable Type
 * Version: 2.2.2
 * Build date: 2017-02-04
 */

!function(a){"use strict";"function"==typeof define&&define.amd?define(a):"undefined"!=typeof module&&"undefined"!=typeof module.exports?module.exports=a():window.Sortable=a()}(function(){"use strict";function a(a,c){this.el=a,this.options=c=c||{};var d={group:Math.random(),store:null,handle:null,draggable:a.children[0]&&a.children[0].nodeName||(/[uo]l/i.test(a.nodeName)?"li":"*"),ghostClass:"sortable-ghost",ignore:"a, img",filter:null};for(var f in d)c[f]=c[f]||d[f];F.forEach(function(d){c[d]=b(this,c[d]||G),e(a,d.substr(2).toLowerCase(),c[d])},this),a[x]=c.group;for(var g in this)"_"===g.charAt(0)&&(this[g]=b(this,this[g]));e(a,"mousedown",this._onTapStart),e(a,"touchstart",this._onTapStart),B&&e(a,"selectstart",this._onTapStart),e(a,"dragover",this._onDragOver),e(a,"dragenter",this._onDragOver),I.push(this._onDragOver),c.store&&this.sort(c.store.get(this))}function b(a,b){var c=H.call(arguments,2);return b.bind?b.bind.apply(b,[a].concat(c)):function(){return b.apply(a,c.concat(H.call(arguments)))}}function c(a,b,c){if("*"===b)return a;if(a){c=c||z,b=b.split(".");var d=b.shift().toUpperCase(),e=new RegExp("\\s("+b.join("|")+")\\s","g");do if(!(""!==d&&a.nodeName!=d||b.length&&((" "+a.className+" ").match(e)||[]).length!=b.length))return a;while(a!==c&&(a=a.parentNode))}return null}function d(a){a.dataTransfer.dropEffect="move",a.preventDefault()}function e(a,b,c){a.addEventListener(b,c,!1)}function f(a,b,c){a.removeEventListener(b,c,!1)}function g(a,b,c){if(a)if(a.classList)a.classList[c?"add":"remove"](b);else{var d=(" "+a.className+" ").replace(/\s+/g," ").replace(" "+b+" ","");a.className=d+(c?" "+b:"")}}function h(a,b,c){if(a&&a.style){if(void 0===c)return z.defaultView&&z.defaultView.getComputedStyle?c=z.defaultView.getComputedStyle(a,""):a.currentStyle&&(c=a.currentStyle),void 0===b?c:c[b];a.style[b]=c+("string"==typeof c?"":"px")}}function i(a,b,c){if(a){var d=a.getElementsByTagName(b),e=0,f=d.length;if(c)for(;e<f;e++)c(d[e],e);return d}return[]}function j(a){return a.draggable=!1}function k(){C=!1}function l(a,b){var c=a.lastElementChild.getBoundingClientRect();return b.clientY-(c.top+c.height)>5}function m(a){for(var b=a.tagName+a.className+a.src+a.href+a.textContent,c=b.length,d=0;c--;)d+=b.charCodeAt(c);return d.toString(36)}var n,o,p,q,r,s,t,u,v,w,x="Sortable"+(new Date).getTime(),y=window,z=y.document,A=y.parseInt,B=!!z.createElement("div").dragDrop,C=!1,D=function(a,b){var c=z.createEvent("Event");return c.initEvent(a,!0,!0),c.item=b,c},E=function(a,b,c){a.dispatchEvent(D(b,c||a))},F="onAdd onUpdate onRemove onStart onEnd onFilter".split(" "),G=function(){},H=[].slice,I=[];return a.prototype={constructor:a,_applyEffects:function(){g(n,this.options.ghostClass,!0)},_onTapStart:function(a){var b=a.touches&&a.touches[0],f=(b||a).target,g=this.options,h=this.el,k=g.filter;if("mousedown"!==a.type||0===a.button){if("function"==typeof k){if(k.call(this,f,this))return void E(h,"filter",f)}else if(k&&(k=k.split(",").filter(function(a){return c(f,a.trim(),h)}),k.length))return void E(h,"filter",f);if(g.handle&&(f=c(f,g.handle,h)),f=c(f,g.draggable,h),f&&"selectstart"==a.type&&"A"!=f.tagName&&"IMG"!=f.tagName&&f.dragDrop(),f&&!n&&f.parentNode===h){v=a,p=this.el,n=f,q=n.nextSibling,u=this.options.group,n.draggable=!0,g.ignore.split(",").forEach(function(a){i(f,a.trim(),j)}),b&&(v={target:f,clientX:b.clientX,clientY:b.clientY},this._onDragStart(v,!0),a.preventDefault()),e(z,"mouseup",this._onDrop),e(z,"touchend",this._onDrop),e(z,"touchcancel",this._onDrop),e(this.el,"dragstart",this._onDragStart),e(this.el,"dragend",this._onDrop),e(z,"dragover",d);try{z.selection?z.selection.empty():window.getSelection().removeAllRanges()}catch(a){}E(n,"start")}}},_emulateDragOver:function(){if(w){h(o,"display","none");var a=z.elementFromPoint(w.clientX,w.clientY),b=a,c=this.options.group,d=I.length;if(b)do{if(b[x]===c){for(;d--;)I[d]({clientX:w.clientX,clientY:w.clientY,target:a,rootEl:b});break}a=b}while(b=b.parentNode);h(o,"display","")}},_onTouchMove:function(a){if(v){var b=a.touches[0],c=b.clientX-v.clientX,d=b.clientY-v.clientY,e="translate3d("+c+"px,"+d+"px,0)";w=b,h(o,"webkitTransform",e),h(o,"mozTransform",e),h(o,"msTransform",e),h(o,"transform",e),a.preventDefault()}},_onDragStart:function(a,b){var c=a.dataTransfer;if(this._offUpEvents(),b){var d,f=n.getBoundingClientRect(),g=h(n);o=n.cloneNode(!0),h(o,"top",f.top-A(g.marginTop,10)),h(o,"left",f.left-A(g.marginLeft,10)),h(o,"width",f.width),h(o,"height",f.height),h(o,"opacity","0.8"),h(o,"position","fixed"),h(o,"zIndex","100000"),p.appendChild(o),d=o.getBoundingClientRect(),h(o,"width",2*f.width-d.width),h(o,"height",2*f.height-d.height),e(z,"touchmove",this._onTouchMove),e(z,"touchend",this._onDrop),e(z,"touchcancel",this._onDrop),this._loopId=setInterval(this._emulateDragOver,150)}else c.effectAllowed="move",c.setData("Text",n.textContent),e(z,"drop",this._onDrop);setTimeout(this._applyEffects)},_onDragOver:function(a){if(!C&&u===this.options.group&&(void 0===a.rootEl||a.rootEl===this.el)){var b=this.el,d=c(a.target,this.options.draggable,b);if(0===b.children.length||b.children[0]===o||b===a.target&&l(b,a))b.appendChild(n);else if(d&&d!==n&&void 0!==d.parentNode[x]){r!==d&&(r=d,s=h(d),t=d.getBoundingClientRect());var e,f=t,g=f.right-f.left,i=f.bottom-f.top,j=/left|right|inline/.test(s.cssFloat+s.display),m=d.offsetWidth>n.offsetWidth,p=d.offsetHeight>n.offsetHeight,q=(j?(a.clientX-f.left)/g:(a.clientY-f.top)/i)>.5,v=d.nextElementSibling;C=!0,setTimeout(k,30),e=j?d.previousElementSibling===n&&!m||q&&m:v!==n&&!p||q&&p,e&&!v?b.appendChild(n):d.parentNode.insertBefore(n,e?v:d)}}},_offUpEvents:function(){f(z,"mouseup",this._onDrop),f(z,"touchmove",this._onTouchMove),f(z,"touchend",this._onDrop),f(z,"touchcancel",this._onDrop)},_onDrop:function(a){clearInterval(this._loopId),f(z,"drop",this._onDrop),f(z,"dragover",d),f(this.el,"dragend",this._onDrop),f(this.el,"dragstart",this._onDragStart),f(this.el,"selectstart",this._onTapStart),this._offUpEvents(),a&&(a.preventDefault(),a.stopPropagation(),o&&o.parentNode.removeChild(o),n&&(j(n),g(n,this.options.ghostClass,!1),p.contains(n)?n.nextSibling!==q&&E(n,"update"):(E(p,"remove",n),E(n,"add")),E(n,"end")),p=n=o=q=v=w=r=s=u=null,this.options.store&&this.options.store.set(this))},toArray:function(){for(var a,b=[],d=this.el.children,e=0,f=d.length;e<f;e++)a=d[e],c(a,this.options.draggable,this.el)&&b.push(a.getAttribute("data-id")||m(a));return b},sort:function(a){var b={},d=this.el;this.toArray().forEach(function(a,e){var f=d.children[e];c(f,this.options.draggable,d)&&(b[a]=f)},this),a.forEach(function(a){b[a]&&(d.removeChild(b[a]),d.appendChild(b[a]))})},closest:function(a,b){return c(a,b||this.options.draggable,this.el)},destroy:function(){var a=this.el,b=this.options;F.forEach(function(c){f(a,c.substr(2).toLowerCase(),b[c])}),f(a,"mousedown",this._onTapStart),f(a,"touchstart",this._onTapStart),f(a,"selectstart",this._onTapStart),f(a,"dragover",this._onDragOver),f(a,"dragenter",this._onDragOver),Array.prototype.forEach.call(a.querySelectorAll("[draggable]"),function(a){a.removeAttribute("draggable")}),I.splice(I.indexOf(this._onDragOver),1),this._onDrop(),this.el=null}},a.utils={on:e,off:f,css:h,find:i,bind:b,closest:c,toggleClass:g,createEvent:D,dispatchEvent:E},a.version="0.5.2",a});var SuperBoxSelectTV=function(a){a=a||{},SuperBoxSelectTV.superclass.constructor.call(this,a)};Ext.extend(SuperBoxSelectTV,Ext.Component,{page:{},window:{},grid:{},tree:{},panel:{},combo:{},config:{},jquery:{},form:{}}),Ext.reg("superboxselecttv",SuperBoxSelectTV);var SuperBoxSelect=new SuperBoxSelectTV;SuperBoxSelect.panel.InputOptions=function(a){a=a||{},this.options=a.options,this.params=a.params,Ext.applyIf(a,{layout:"form",autoHeight:!0,cls:"form-with-labels",labelAlign:"top",border:!1,items:[{xtype:"modx-combo",fieldLabel:_("superboxselect.selectType"),description:MODx.expandHelp?"":_("superboxselect.selectType_desc"),name:"inopt_selectType",hiddenName:"inopt_selectType",id:"inopt_selectType",value:this.params.selectType||"resources",anchor:"100%",url:SuperBoxSelect.config.connectorUrl,baseParams:{action:"mgr/selecttypes/getList",tvId:MODx.request.id,package:this.params.selectPackage||""},listeners:{select:{fn:this.selectType,scope:this}}},{xtype:MODx.expandHelp?"label":"hidden",forId:"inopt_selectType",html:_("superboxselect.selectType_desc"),cls:"desc-under"},{xtype:"textfield",fieldLabel:_("superboxselect.selectPackage"),description:MODx.expandHelp?"":_("superboxselect.selectPackage_desc"),name:"inopt_selectPackage",id:"inopt_selectPackage",value:this.params.selectPackage||"",anchor:"100%",hidden:!SuperBoxSelect.config.advanced,listeners:{change:{fn:this.markDirty,scope:this}}},{xtype:MODx.expandHelp?"label":"hidden",forId:"inopt_selectPackage",html:_("superboxselect.selectPackage_desc"),cls:"desc-under",hidden:!SuperBoxSelect.config.advanced},{xtype:"textfield",fieldLabel:_("superboxselect.maxElements"),description:MODx.expandHelp?"":_("superboxselect.maxElements_desc"),name:"inopt_maxElements",id:"inopt_maxElements",value:this.params.maxElements||this.params.maxResources||"",anchor:"100%",listeners:{change:{fn:this.markDirty,scope:this}}},{xtype:MODx.expandHelp?"label":"hidden",forId:"inopt_maxElements",html:_("superboxselect.maxElements_desc"),cls:"desc-under"},{xtype:"textfield",fieldLabel:_("superboxselect.fieldTpl"),description:MODx.expandHelp?"":_("superboxselect.fieldTpl_desc"),name:"inopt_fieldTpl",id:"inopt_fieldTpl",value:this.params.fieldTpl||"",anchor:"100%",hidden:!SuperBoxSelect.config.advanced,listeners:{change:{fn:this.markDirty,scope:this}}},{xtype:MODx.expandHelp?"label":"hidden",forId:"inopt_fieldTpl",html:_("superboxselect.fieldTpl_desc"),cls:"desc-under",hidden:!SuperBoxSelect.config.advanced},{xtype:"combo-boolean",fieldLabel:_("required"),description:MODx.expandHelp?"":_("required_desc"),name:"inopt_allowBlank",hiddenName:"inopt_allowBlank",id:"inopt_allowBlank",value:0==this.params.allowBlank||"false"==this.params.allowBlank?0:1,anchor:"100%",listeners:{change:{fn:this.markDirty,scope:this}}},{xtype:MODx.expandHelp?"label":"hidden",forId:"inopt_allowBlank",html:_("required_desc"),cls:"desc-under"},{xtype:"superboxselect-panel-inputoptions-types",params:this.params},{xtype:"numberfield",fieldLabel:_("superboxselect.pageSize"),description:MODx.expandHelp?"":_("superboxselect.pageSize_desc"),name:"inopt_pageSize",id:"inopt_pageSize",value:this.params.pageSize||10,allowNegative:!1,allowDecimals:!1,anchor:"100%",listeners:{change:{fn:this.markDirty,scope:this}}},{xtype:MODx.expandHelp?"label":"hidden",forId:"inopt_pageSize",html:_("superboxselect.pageSize_desc"),cls:"desc-under"}],listeners:{afterrender:{fn:this.inputOptionsAfterRender,scope:this}}}),SuperBoxSelect.panel.InputOptions.superclass.constructor.call(this,a)},Ext.extend(SuperBoxSelect.panel.InputOptions,MODx.Panel,{selectType:function(a,b){var c=Ext.getCmp("modx-input-props").getEl().select(".alltypes");c&&c.each(function(a){a.setStyle("height","0")});var d=Ext.getCmp("type_"+b.id);d&&d.getEl().setStyle("height",null)},inputOptionsAfterRender:function(){var a=Ext.getCmp("inopt_selectType").getValue();if(a){var b=Ext.getCmp("type_"+a);b&&b.getEl().setStyle("height",null)}var c=Ext.getCmp("modx-tv-elements");c&&c.itemCt.applyStyles({height:"0",overflow:"hidden"})},markDirty:function(){Ext.getCmp("modx-panel-tv").markDirty()}}),Ext.reg("superboxselect-panel-inputoptions",SuperBoxSelect.panel.InputOptions),SuperBoxSelect.combo.SuperBoxSelectTV=function(a){a=a||{},this.options=a.options,this.params=a.params,this.tvid=this.options.tvid,this.maxElements=this.options.maxElements,Ext.applyIf(a,{addNewDataOnBlur:!1,allowBlank:this.options.allowBlank,anchor:"100%",classField:"cls",ctCls:"superboxselect-tv",displayField:"title",displayFieldTpl:this.options.fieldTpl,fieldLabel:this.options.fieldLabel,listeners:{afterrender:{fn:this.afterrender,scope:this},beforeadditem:{fn:this.beforeadditem,scope:this},additem:{fn:this.additem,scope:this},removeitem:{fn:this.removeitem,scope:this}},minChars:2,mode:"remote",msgTarget:"title",name:"tv"+this.tvid+"[]",pageSize:this.options.pageSize,queryDelay:0,store:this.options.store,styleField:"style",tpl:'<tpl for="."><div class="x-combo-list-item">'+this.options.fieldTpl+"</div></tpl>",transform:"superboxselect-tv-"+this.tvid,triggerAction:"all",value:this.options.value,valueField:"id",width:400}),SuperBoxSelect.combo.SuperBoxSelectTV.superclass.constructor.call(this,a)},SuperBoxSelect.combo.SuperBoxSelectTV=Ext.extend(SuperBoxSelect.combo.SuperBoxSelectTV,Ext.ux.form.SuperBoxSelect,{afterrender:function(){if(this.maxElements){var a=Ext.get("tv"+this.tvid+"-caption"),b=_("superboxselect.maxElements_label").replace("{maxElements}",this.maxElements);a.dom.innerHTML=a.dom.innerHTML+' <span class="modx-tv-label-description">('+b+")</span>"}var c=this,d=document.querySelectorAll("#"+this.outerWrapEl.id+" ul")[0];d?(d.setAttribute("data-xcomponentid",this.id),new Sortable(d,{onEnd:function(a){if(a.currentTarget){var b=a.currentTarget.getAttribute("data-xcomponentid"),d=Ext.getCmp(b);d?(c.refreshSorting(d),MODx.fireResourceFormChange()):console.log("Unable to reference xComponentContext.")}}})):console.log("Unable to find select element")},beforeadditem:function(a){if(this.maxElements)return!(a.getCount()>this.maxElements-1)||(MODx.msg.alert(_("error"),_("superboxselect.maxElements_msg")),!1)},additem:function(){MODx.fireResourceFormChange()},removeitem:function(){MODx.fireResourceFormChange()},refreshSorting:function(a){var b=a.items.items,c=document.querySelectorAll("#"+a.outerWrapEl.dom.id+" .x-superboxselect-input"),d=function(a){var b=Array.prototype.slice.call(a.parentElement.children);return b.indexOf(a)},e=function(a,b){for(var c=0;c<b.length;c+=1)if(b[c].value==a)return b[c]},f=function(a,b){a.sort(h),b instanceof Function&&b()},g=function(a,b,c){var d=b[0].parentElement;if(!d)return console.debug("syncElementsByValue(), Unable to reference list root element."),!1;for(var f=0;f<a.length;f+=1){var g=a[f],h=e(g.value,b),i=b[f];null!==h&&void 0!==i&&d.insertBefore(h,i)}c instanceof Function&&c()},h=function(a,b){var c=d(a.el.dom),e=d(b.el.dom);return c<e?-1:c>e?1:0};f(b),g(b,c[0].children),a.value=a.getValue()},getElementComponentContext:function(a){var b=Array.prototype.slice.call(a.classList);return"body"!==a.tagName?null:b.indexOf("x-superboxselect")?a:void getElementComponentContext(a.parentElement)}}),Ext.reg("superboxselect-combo-superboxselectv",SuperBoxSelect.combo.SuperBoxSelectTV),SuperBoxSelect.combo.SuperBoxSelectTVSingle=function(a){a=a||{},this.options=a.options,this.params=a.params,this.tvid=this.options.tvid,Ext.applyIf(a,{allowBlank:this.options.allowBlank,anchor:"100%",ctCls:"superboxselect-tv",displayField:"title",fieldLabel:this.options.fieldLabel,hiddenName:"tv"+this.tvid,minChars:2,mode:"remote",msgTarget:"title",name:"tv"+this.tvid,pageSize:this.options.pageSize,queryDelay:0,store:this.options.store,tpl:'<tpl for="."><div class="x-combo-list-item">'+this.options.fieldTpl+"</div></tpl>",transform:"superboxselect-tv-"+this.tvid,triggerAction:"all",value:this.options.value,valueField:"id",width:400}),SuperBoxSelect.combo.SuperBoxSelectTVSingle.superclass.constructor.call(this,a)},SuperBoxSelect.combo.SuperBoxSelectTVSingle=Ext.extend(SuperBoxSelect.combo.SuperBoxSelectTVSingle,Ext.form.ComboBox),Ext.reg("superboxselect-combo-superboxselectv-single",SuperBoxSelect.combo.SuperBoxSelectTVSingle),SuperBoxSelect.Renderer=function(a){return a.length,""};